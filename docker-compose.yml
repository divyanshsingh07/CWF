# EC2 production: single entry point via Nginx (port 80). Frontend + API same origin â†’ CORS works.
# On EC2: set backend/.env.prod (MONGODB_URI, JWT_SECRET, JWT_EXPIRE, ALLOWED_ORIGINS=http://YOUR_EC2_IP)
# Run: docker compose up -d --build

version: "3.9"

services:
  backend:
    build:
      context: ./backend
    image: minicourses-backend:prod
    container_name: minicourses-backend
    restart: unless-stopped
    env_file:
      - ./backend/.env.prod
    environment:
      NODE_ENV: production
      PORT: 4000
    expose:
      - "4000"
    networks:
      - app-net

  frontend:
    build:
      context: ./frontend
      args:
        VITE_API_URL=/api
    image: minicourses-frontend:prod
    container_name: minicourses-frontend
    restart: unless-stopped
    expose:
      - "80"
    networks:
      - app-net

  nginx:
    image: nginx:1.27-alpine
    container_name: minicourses-nginx
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./nginx/proxy.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - backend
      - frontend
    networks:
      - app-net

networks:
  app-net:
    driver: bridge
